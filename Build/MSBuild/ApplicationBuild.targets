<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<ApplicationProjectOutputDirectory>$(OutDir)_PublishedApplications\$(MSBuildProjectName)</ApplicationProjectOutputDirectory>
	</PropertyGroup>

	<PropertyGroup>
		<PrepareForRunDependsOn>
			$(PrepareForRunDependsOn);
			_CopyApplications
		</PrepareForRunDependsOn>
	</PropertyGroup>


	<Target Name="_CopyApplications" Condition="'$(OutDir)' != '$(OutputPath)'">
		<!-- Log tasks -->
		<Message Text="Copying Application Tests Project Files for $(MSBuildProjectName)" />

		<!-- Create the _PublishedWebsites\app\bin folder -->
		<MakeDir Directories="$(ApplicationProjectOutputDirectory)\bin" />

    <!-- Copy build outputs to _PublishedWebsites\app\bin folder -->
    <Copy SourceFiles="@(IntermediateAssembly)" DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="@(AddModules)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="$(IntermediateOutputPath)$(_SGenDllName)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\%(Content.SubFolder)%(Content.RecursiveDir)"
			  SkipUnchangedFiles="true"
			  Condition="'$(_SGenDllCreated)'=='true'"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="$(IntermediateOutputPath)$(TargetName).pdb"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="true"
			  Condition="'$(_DebugSymbolsProduced)'=='true'"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="@(DocFileItem)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="true"
			  Condition="'$(_DocumentationFileProduced)'=='true'"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="@(IntermediateSatelliteAssembliesWithTargetPath)"
			  DestinationFiles="@(IntermediateSatelliteAssembliesWithTargetPath->'$(ApplicationProjectOutputDirectory)\bin\%(Culture)\$(TargetName).resources.dll')"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="@(ReferenceComWrappersToCopyLocal); @(ResolvedIsolatedComModules); @(_DeploymentLooseManifestFile); @(NativeReferenceFile)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>

    <!-- copy any referenced assemblies to _PublishedWebsites\app\bin folder -->
    <Copy SourceFiles="@(ReferenceCopyLocalPaths)"
			  DestinationFiles="@(ReferenceCopyLocalPaths->'$(ApplicationProjectOutputDirectory)\bin\%(DestinationSubDirectory)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>

    <!-- Copy content files recursively to _PublishedWebsites\app\ folder -->
    <Copy SourceFiles="@(Content)" Condition="'%(Content.Link)' == ''"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\%(Content.RelativeDir)"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)" />
    <Copy SourceFiles="@(Content)" Condition="'%(Content.Link)' != ''"
			  DestinationFiles="$(ApplicationProjectOutputDirectory)\%(Content.Link)"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>

    <!-- Copy items that have been marked to be copied to the bin folder -->
    <Copy SourceFiles="@(_SourceItemsToCopyToOutputDirectory)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>
    <Copy SourceFiles="@(_SourceItemsToCopyToOutputDirectoryAlways)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin"
			  SkipUnchangedFiles="false"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>

    <!-- Copy Silverlight Zip and Xzp file to _PublishedWebsites\app\ folder-->
    <Copy SourceFiles="@(_WebApplicationSilverlightXapFiles)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\%(_WebApplicationSilverlightXapFiles.RelativeDir)"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>

    <!-- Copy items that need to be bin deployed to the bin folder -->
    <Copy SourceFiles="@(_binDeployableAssemblies)"
			  DestinationFolder="$(ApplicationProjectOutputDirectory)\bin\%(_binDeployableAssemblies.DestinationRelPath)"
			  SkipUnchangedFiles="true"
			  Retries="$(CopyRetryCount)"
			  RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"/>

  </Target>

</Project>